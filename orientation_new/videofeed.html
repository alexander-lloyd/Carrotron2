<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Feed</title>
    <style>
        table {
            height:100%;
            width:100%;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        * {
            margin: 0;
        }

        td {
            width: 50%;
        }

        video {
            position: absolute;
            z-index: 0;
            top: 0;
            min-width: 50%;
            max-width: 50%;
            min-height: 100%;
            width: auto;
            height: auto;
        }

        video#rightfeed {
            left: 50%;
        }

        video#leftfeed {
            left: 0;
        }
    </style>
</head>
<body>
<!--<table>-->
    <!--<tr>-->
        <!--<td></video></td>-->
        <!--<td>></td>-->
    <!--</tr>-->
<!--</table>-->

<table>
    <tr style="height: 100%;">
        <td>
            <video id="leftfeed">
            </video>
        </td>
        <td><video id="rightfeed"></video></td>
    </tr>
</table>â€‹
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub-3.7.14.min.js"></script>
<script src="https://cdn.pubnub.com/webrtc/webrtc.js"></script>
<script src="https://cdn.pubnub.com/webrtc/rtc-controller.js"></script>
<script>
    const ADDRESS = '10.4.180.77';
    const PORT = '8080';


    var leftVideo = document.getElementById('leftfeed');
    var rightVideo = document.getElementById('rightfeed');

    var stream;

    var signalling_server_hostname = ADDRESS;
    var signalling_server_fqdn = ADDRESS + ':' + PORT;

    RTCPeerConnection = window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    RTCSessionDescription = window.mozRTCSessionDescription || window.RTCSessionDescription;
    RTCIceCandidate = window.mozRTCIceCandidate || window.RTCIceCandidate;
    navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia || navigator.msGetUserMedia;
    var URL = window.URL || window.webkitURL;

    var pcConfig = {"iceServers": [
                    {"urls": ["stun:stun.l.google.com:19302", "stun:" + signalling_server_hostname + ":3478"]}
                ]};
    var pcOptions = {
        optional: [
            // Deprecated:
            //{RtpDataChannels: false},
            //{DtlsSrtpKeyAgreement: true}
        ]
    };

    function onRemoteStreamAdded(event) {
          console.log("Remote stream added:", URL.createObjectURL(event.stream));

          leftVideo.src = URL.createObjectURL(event.stream);

          if (leftVideo.captureStream) {
            stream = leftVideo.captureStream();
            rightVideo.srcObject = stream; // Set right video to left
            console.log('Captured stream from leftVideo with captureStream', stream);
          }
          else if (leftVideo.mozCaptureStream) {
            stream = leftVideo.mozCaptureStream();
            rightVideo.srcObject = stream;
            console.log('Captured stream from leftVideo with mozCaptureStream()', stream);
          } else {
            console.log('captureStream() not supported');
          }
          leftVideo.play();
    }

    function onRemoteStreamRemoved() {
        leftVideo.src = '';
    }


    function maybeCreateStream() {
      if (stream) {
        return;
      }
      if (leftVideo.captureStream) {
        stream = leftVideo.captureStream();
        rightVideo.srcObject = stream; // Set right video to left
        console.log('Captured stream from leftVideo with captureStream', stream);
      } else if (leftVideo.mozCaptureStream) {
        stream = leftVideo.mozCaptureStream();
        rightVideo.srcObject = stream;
        console.log('Captured stream from leftVideo with mozCaptureStream()', stream);
      } else {
        console.log('captureStream() not supported');
      }
    }

    function createPeerConnection(){
      pc = new RTCPeerConnection(pcConfig, pcOptions);
      pc.onaddstream = onRemoteStreamAdded;
      pc.onremovestream = onRemoteStreamRemoved;

      console.log("peer connection successfully created!");
    }


//    leftVideo.oncanplay = maybeCreateStream;

//    if (leftVideo.readyState >= 3) {  // HAVE_FUTURE_DATA
//      // Video is already ready to play, call maybeCreateStream in case oncanplay
//      // fired before we registered the event handler.
//      maybeCreateStream();
//    }
//


    function start() {
      if ("WebSocket" in window) {
        server = signalling_server_fqdn;
        var protocol = location.protocol === "https:" ? "wss:" : "ws:";
        ws = new WebSocket(protocol + '//' + server + '/stream/webrtc');
      }

      function call(stream) {
        createPeerConnection();
        if (stream) {
          pc.addStream(stream);
        }
        var request = {
          what: "call",
            options: {
                                force_hw_vcodec: document.getElementById("remote_hw_vcodec").checked,
                                vformat: document.getElementById("remote_vformat").value
                            }
                        };
                        ws.send(JSON.stringify(request));
                        console.log("call(), request=" + JSON.stringify(request));
                    }




    }

















    window.onload = function() {
      start();
    }
</script>

</body>
</html>